name: Terraform-Run-From-Golden-Image
on:
  push:
    branches: [ "master" ]
  workflow_dispatch: # This enables the manual "Run workflow" buttons


jobs:
  # JOB 1: Authenticate and Pull the Image
  setup:
    runs-on: ubuntu-latest
    permissions:
      id-token: write   # Required for OIDC
      contents: read    # Required for Checkout
    steps:
      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Pull Golden Image to Runner Cache
        run: docker pull 702175642104.dkr.ecr.us-east-1.amazonaws.com/abhishek-ecr/abhishek-ecr:Terraform_golden_image_v1.0.16

  # JOB 2: Run Terraform inside that Cached Image
  terraform:
    needs: setup
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    container:
      image: 702175642104.dkr.ecr.us-east-1.amazonaws.com/abhishek-ecr/abhishek-ecr:Terraform_golden_image_v1.0.16
      options: --user root
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Configure AWS (Inside Container)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      - name: Terraform Init
        run: terraform init -backend-config=Environments/spiderbackends.conf


      
        

